<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hyping-style Shop</title>
  <style>
    /* ton CSS reste inchangÃ© */
  </style>
</head>
<body>
  <!-- ton HTML reste inchangÃ© -->

<script>
const fmt=n=>(n||0).toLocaleString("fr-FR",{style:"currency",currency:"EUR"});
function toast(msg,ms=1600){
  const box=document.getElementById("toast");
  box.textContent=msg;
  box.classList.add("show");
  setTimeout(()=>box.classList.remove("show"),ms);
}

let PRODUCTS=[];
async function loadProducts(){
  try{
    const res=await fetch("products.json");
    PRODUCTS=await res.json();
    renderProducts();
  }catch(e){toast("Erreur chargement produits");}
}

const grid=document.getElementById("productGrid");
function renderProducts(list=PRODUCTS){
  grid.innerHTML="";
  list.forEach(p=>{
    const card=document.createElement("article");
    card.className="card";
    card.innerHTML=`
      <div class="thumb"><img src="${p.image}" alt=""></div>
      <div class="meta"><div><div class="title">${p.name}</div><div class="tag">#${p.tag}</div></div><div class="price">${fmt(p.price)}</div></div>
      <div class="actions">
        <div class="qty"><button data-action="dec">âˆ’</button><input type="number" min="1" value="1"/><button data-action="inc">+</button></div>
        <button class="btn add" data-id="${p.id}">Ajouter</button>
      </div>`;
    const input=card.querySelector("input");
    card.querySelector('[data-action="inc"]').onclick=()=>input.value=(+input.value||1)+1;
    card.querySelector('[data-action="dec"]').onclick=()=>input.value=Math.max(1,(+input.value||1)-1);
    card.querySelector(".btn.add").onclick=()=>addToCart(p.id,+input.value||1);
    grid.appendChild(card);
  });
}

let CART=[];
const cartList=document.getElementById("cartList"),cartEmpty=document.getElementById("cartEmpty");
const subtotalEl=document.getElementById("subtotal"),feesEl=document.getElementById("fees"),totalEl=document.getElementById("total");

function syncCartUI(){
  if(CART.length===0){
    cartEmpty.hidden=false;cartList.hidden=true;cartList.innerHTML="";
    subtotalEl.textContent=fmt(0);feesEl.textContent=fmt(0);totalEl.textContent=fmt(0);
    return;
  }
  cartEmpty.hidden=true;cartList.hidden=false;cartList.innerHTML="";
  let subtotal=0;
  CART.forEach(item=>{
    const lineTotal=item.price*item.qty;subtotal+=lineTotal;
    const row=document.createElement("div");row.className="cart-item";
    row.innerHTML=`<div><div class="name">${item.name}</div><div class="tag">${fmt(item.price)} Ã— ${item.qty}</div></div><div class="line"><strong>${fmt(lineTotal)}</strong><button class="remove">âœ•</button></div>`;
    row.querySelector(".remove").onclick=()=>{CART=CART.filter(x=>x.id!==item.id);syncCartUI();};
    cartList.appendChild(row);
  });
  const fees=subtotal>0?Math.max(2,subtotal*0.02):0;
  subtotalEl.textContent=fmt(subtotal);feesEl.textContent=fmt(fees);totalEl.textContent=fmt(subtotal+fees);
}
function addToCart(id,qty=1){
  const p=PRODUCTS.find(x=>x.id===id);if(!p)return;
  const ex=CART.find(x=>x.id===id);
  if(ex){ex.qty+=qty;}else{CART.push({id:p.id,name:p.name,price:p.price,qty});}
  syncCartUI();toast("AjoutÃ© au panier");
}

/* âœ… correction principale ici */
function buildOrder(pseudoDiscord,pseudoMinecraft){
  const items=CART.map(x=>({
    name:x.name,
    qty:x.qty,
    unit:x.price.toFixed(2)+" â‚¬",
    total:(x.price*x.qty).toFixed(2)+" â‚¬"
  }));
  const subtotal=items.reduce((s,i)=>s+parseFloat(i.total),0);
  const fees=subtotal>0?Math.max(2,subtotal*0.02):0;
  const total=subtotal+fees;

  return {
    content:"ðŸ›’ Nouvelle commande",
    embeds:[{
      title:"Nouvelle Commande",
      color:5814783,
      fields:[
        {name:"Pseudo Discord",value:pseudoDiscord||"Non fourni"},
        {name:"Pseudo Minecraft",value:pseudoMinecraft||"Non fourni"},
        {name:"Articles",value:items.map(i=>`**${i.name}** Ã—${i.qty} = ${i.total}`).join("\n")||"Aucun"},
        {name:"Sous-total",value:subtotal.toFixed(2)+" â‚¬",inline:true},
        {name:"Frais",value:fees.toFixed(2)+" â‚¬",inline:true},
        {name:"Total",value:total.toFixed(2)+" â‚¬",inline:true}
      ],
      footer:{text:"Commande ID: "+Date.now()}
    }]
  };
}

const modal=document.getElementById("orderModal");
document.getElementById("sendOrder").onclick=()=>{
  if(CART.length===0){toast("Ajoutez des articles");return;}
  modal.style.display="flex";
};
document.getElementById("cancelOrder").onclick=()=>{modal.style.display="none";};

/* âœ… correction webhook ici */
document.getElementById("confirmOrder").onclick=async()=>{
  const pseudoDiscord=document.getElementById("pseudoDiscord").value.trim();
  const pseudoMinecraft=document.getElementById("pseudoMinecraft").value.trim();
  const order=buildOrder(pseudoDiscord,pseudoMinecraft);
  try{
    const WEBHOOK_URL="https://discord.com/api/webhooks/TON_ID/TON_TOKEN"; // mets ton vrai webhook
    const res=await fetch(WEBHOOK_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(order)
    });
    console.log("RÃ©ponse webhook:",res.status);
    if(res.status===204){
      toast("Commande envoyÃ©e âœ…");
      modal.style.display="none";
      CART=[];syncCartUI();
    }else{
      throw new Error("HTTP "+res.status);
    }
  }catch(e){
    console.error(e);
    toast("Ã‰chec envoi âŒ");
  }
};

document.getElementById("clearCart").onclick=()=>{CART=[];syncCartUI();toast("Panier vidÃ©");};

const searchInput=document.getElementById("searchInput");
searchInput.addEventListener("input",e=>{
  const q=e.target.value.trim().toLowerCase();
  if(!q){renderProducts();return;}
  const filtered=PRODUCTS.filter(p=>p.name.toLowerCase().includes(q)||(p.tag||"").toLowerCase().includes(q));
  renderProducts(filtered);
});
document.getElementById("resetFilters").onclick=()=>{searchInput.value="";renderProducts();};

loadProducts();syncCartUI();
</script>
</body>
</html>
